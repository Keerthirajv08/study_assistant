<!-- templates/base/chat.html -->
{% extends 'base.html' %}

{% block title %}Chat - Student AI Assistant{% endblock %}

{% block extra_css %}
<style>
    .chat-container {
        height: calc(100vh - 76px);
        overflow: hidden;
    }
    
    .chat-sidebar {
        background-color: #f8f9fa;
        border-right: 1px solid #dee2e6;
        height: 100%;
        overflow-y: auto;
    }
    
    .chat-main {
        display: flex;
        flex-direction: column;
        height: 100%;
    }
    
    .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
    }
    
    .chat-input-area {
        background-color: white;
        border-top: 1px solid #dee2e6;
        padding: 20px;
    }
    
    .session-item {
        padding: 12px 16px;
        border-bottom: 1px solid #dee2e6;
        cursor: pointer;
        transition: background-color 0.2s;
    }
    
    .session-item:hover {
        background-color: #e9ecef;
    }
    
    .session-item.active {
        background-color: #007bff;
        color: white;
    }
    
    .session-title {
        font-weight: 500;
        font-size: 0.9rem;
        margin-bottom: 4px;
    }
    
    .session-date {
        font-size: 0.75rem;
        opacity: 0.7;
    }
    
    .typing-indicator {
        display: none;
        text-align: left;
        margin-bottom: 15px;
    }
    
    .typing-bubble {
        background-color: white;
        border: 1px solid #e0e0e0;
        border-radius: 18px 18px 18px 5px;
        display: inline-block;
        padding: 12px 18px;
        max-width: 70%;
    }
    
    .typing-dots {
        display: inline-block;
        position: relative;
        width: 40px;
        height: 20px;
    }
    
    .typing-dots span {
        position: absolute;
        width: 6px;
        height: 6px;
        border-radius: 50%;
        background-color: #999;
        animation: typing 1.4s infinite ease-in-out;
    }
    
    .typing-dots span:nth-child(1) { left: 0; animation-delay: -0.32s; }
    .typing-dots span:nth-child(2) { left: 12px; animation-delay: -0.16s; }
    .typing-dots span:nth-child(3) { left: 24px; }
    
    @keyframes typing {
        0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
        40% { transform: scale(1); opacity: 1; }
    }
    
    .send-btn {
        border-radius: 50%;
        width: 45px;
        height: 45px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    @media (max-width: 768px) {
        .chat-sidebar {
            position: fixed;
            left: -300px;
            top: 76px;
            width: 300px;
            z-index: 1000;
            transition: left 0.3s;
        }
        
        .chat-sidebar.show {
            left: 0;
        }
        
        .overlay {
            position: fixed;
            top: 76px;
            left: 0;
            width: 100%;
            height: calc(100% - 76px);
            background: rgba(0,0,0,0.5);
            z-index: 999;
            display: none;
        }
        
        .overlay.show {
            display: block;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="chat-container">
    <div class="row g-0 h-100">
        <!-- Sidebar -->
        <div class="col-lg-3 chat-sidebar" id="chatSidebar">
            <div class="p-3 border-bottom">
                <div class="d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">Chat History</h6>
                    <button class="btn btn-sm btn-outline-primary" onclick="createNewChat()">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
            </div>
            
            <div class="sessions-list">
                {% for session in recent_sessions %}
                <div class="session-item {% if session.id == chat_session.id %}active{% endif %}" 
                     onclick="loadSession({{ session.id }})">
                    <div class="session-title">{{ session.title|truncatechars:30 }}</div>
                    <div class="session-date">{{ session.updated_at|date:"M d, Y" }}</div>
                </div>
                {% empty %}
                <div class="p-3 text-muted text-center">
                    <i class="fas fa-comments mb-2"></i><br>
                    No chat history yet
                </div>
                {% endfor %}
            </div>
        </div>
        
        <!-- Main Chat Area -->
        <div class="col-lg-9">
            <!-- Mobile Menu Button -->
            <div class="d-lg-none p-2 border-bottom">
                <button class="btn btn-outline-secondary btn-sm" onclick="toggleSidebar()">
                    <i class="fas fa-bars"></i> Chat History
                </button>
            </div>
            
            <div class="chat-main">
                <!-- Chat Header -->
                <div class="chat-header p-3 border-bottom bg-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="mb-0">{{ chat_session.title }}</h5>
                            <small class="text-muted">AI Study Assistant</small>
                        </div>
                        <div class="dropdown">
                            <button class="btn btn-outline-secondary btn-sm dropdown-toggle" data-bs-toggle="dropdown">
                                <i class="fas fa-cog"></i>
                            </button>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="#" onclick="clearChat()">
                                    <i class="fas fa-trash"></i> Clear Chat
                                </a></li>
                                <li><a class="dropdown-item" href="{% url 'delete_session' chat_session.id %}" 
                                       onclick="return confirm('Delete this chat session?')">
                                    <i class="fas fa-times"></i> Delete Session
                                </a></li>
                            </ul>
                        </div>
                    </div>
                </div>
                
                <!-- Messages Area -->
                <div class="chat-messages" id="chatMessages">
                    {% if not messages %}
                    <div class="text-center text-muted py-5">
                        <i class="fas fa-robot" style="font-size: 4rem; opacity: 0.3;"></i>
                        <h4 class="mt-3">Welcome to StudyAI!</h4>
                        <p>Ask me anything about your studies. I'm here to help!</p>
                        
                        <!-- Quick Start Buttons -->
                        <div class="mt-4">
                            <button class="btn btn-outline-primary btn-sm me-2 mb-2" onclick="sendQuickMessage('Help me with math homework')">
                                üìä Math Help
                            </button>
                            <button class="btn btn-outline-primary btn-sm me-2 mb-2" onclick="sendQuickMessage('Explain a science concept')">
                                üî¨ Science Concepts
                            </button>
                            <button class="btn btn-outline-primary btn-sm me-2 mb-2" onclick="sendQuickMessage('Help me study for a test')">
                                üìö Study Tips
                            </button>
                            <button class="btn btn-outline-primary btn-sm me-2 mb-2" onclick="sendQuickMessage('Help me write an essay')">
                                ‚úçÔ∏è Writing Help
                            </button>
                        </div>
                    </div>
                    {% endif %}
                    
                    {% for message in messages %}
                    <div class="chat-message {{ message.message_type }}-message">
                        <div class="message-bubble">
                            {{ message.content|linebreaks }}
                        </div>
                        <div class="timestamp">
                            {{ message.timestamp|date:"H:i" }}
                        </div>
                    </div>
                    {% endfor %}
                    
                    <!-- Typing Indicator -->
                    <div class="typing-indicator" id="typingIndicator">
                        <div class="typing-bubble">
                            <div class="typing-dots">
                                <span></span>
                                <span></span>
                                <span></span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Input Area -->
                <div class="chat-input-area">
                    <form id="chatForm" class="d-flex gap-2">
                        <input type="text" 
                               class="form-control chat-input" 
                               id="messageInput" 
                               placeholder="Ask me anything about your studies..." 
                               maxlength="1000"
                               autocomplete="off">
                        <button type="submit" class="btn btn-primary send-btn" id="sendBtn">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </form>
                    <div class="text-muted small mt-2">
                        Press Enter to send ‚Ä¢ AI responses are for educational guidance
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Mobile Overlay -->
<div class="overlay" id="mobileOverlay" onclick="toggleSidebar()"></div>
{% endblock %}

{% block extra_js %}
<script>
// Chat functionality
const chatMessages = document.getElementById('chatMessages');
const messageInput = document.getElementById('messageInput');
const chatForm = document.getElementById('chatForm');
const sendBtn = document.getElementById('sendBtn');
const typingIndicator = document.getElementById('typingIndicator');

// Auto-scroll to bottom
function scrollToBottom() {
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

// Add message to chat
function addMessage(content, type, timestamp = null) {
    const messageDiv = document.createElement('div');
    messageDiv.className = `chat-message ${type}-message`;
    
    const now = timestamp || new Date();
    const timeString = now.toLocaleTimeString('en-US', { 
        hour: '2-digit', 
        minute: '2-digit',
        hour12: false 
    });
    
    messageDiv.innerHTML = `
        <div class="message-bubble">
            ${content.replace(/\n/g, '<br>')}
        </div>
        <div class="timestamp">${timeString}</div>
    `;
    
    chatMessages.appendChild(messageDiv);
    scrollToBottom();
    return messageDiv;
}

// Show/hide typing indicator
function showTyping() {
    typingIndicator.style.display = 'block';
    scrollToBottom();
}

function hideTyping() {
    typingIndicator.style.display = 'none';
}

// Send message
async function sendMessage(message) {
    if (!message.trim()) return;
    
    // Add user message
    addMessage(message, 'user');
    
    // Clear input and disable send button
    messageInput.value = '';
    sendBtn.disabled = true;
    showTyping();
    
    try {
        const response = await fetch('{% url "send_message" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || ''
            },
            body: JSON.stringify({
                session_id: {{ chat_session.id }},
                message: message
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Add AI response
            addMessage(data.ai_message.content, 'ai');
            
            // Update session title if changed
            if (data.session_title) {
                document.querySelector('h5').textContent = data.session_title;
            }
        } else {
            addMessage('Sorry, I encountered an error. Please try again.', 'ai');
        }
    } catch (error) {
        console.error('Error:', error);
        addMessage('Sorry, I couldn\'t process your message. Please check your connection and try again.', 'ai');
    } finally {
        hideTyping();
        sendBtn.disabled = false;
        messageInput.focus();
    }
}

// Quick message sender
function sendQuickMessage(message) {
    messageInput.value = message;
    sendMessage(message);
}

// Form submission
chatForm.addEventListener('submit', (e) => {
    e.preventDefault();
    const message = messageInput.value.trim();
    if (message) {
        sendMessage(message);
    }
});

// Enter key handling
messageInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        const message = messageInput.value.trim();
        if (message) {
            sendMessage(message);
        }
    }
});

// Session management
function loadSession(sessionId) {
    window.location.href = `/chat/${sessionId}/`;
}

function createNewChat() {
    window.location.href = '{% url "new_chat" %}';
}

function clearChat() {
    if (confirm('Are you sure you want to clear this chat? This action cannot be undone.')) {
        // Reload page to start fresh
        window.location.reload();
    }
}

// Mobile sidebar toggle
function toggleSidebar() {
    const sidebar = document.getElementById('chatSidebar');
    const overlay = document.getElementById('mobileOverlay');
    
    sidebar.classList.toggle('show');
    overlay.classList.toggle('show');
}

// Initialize
document.addEventListener('DOMContentLoaded', () => {
    messageInput.focus();
    scrollToBottom();
    
    // Handle URL parameters (e.g., topic selection)
    const urlParams = new URLSearchParams(window.location.search);
    const topic = urlParams.get('topic');
    if (topic) {
        messageInput.value = `I need help with ${topic}`;
        // Auto-send after a brief delay
        setTimeout(() => {
            sendMessage(`I need help with ${topic}`);
        }, 1000);
    }
});

// Add CSRF token to all AJAX requests
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock %}